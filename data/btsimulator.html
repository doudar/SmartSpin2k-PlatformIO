<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SmartSpin2k BLE Simulator</title>
  <style>html{background-color:#03245c}</style>
</head>
<body>
  <div class="page-container">
    <header>
      <nav aria-label="Main navigation">
        <a href="index.html" class="back-link" aria-label="Back to main menu">‚Üê Main Menu</a>
        <a href="http://github.com/doudar/SmartSpin2k" class="github-link">SmartSpin2k</a>
      </nav>
    </header>

    <main>
      <div id="loadingWatermark" class="watermark" aria-hidden="true">Loading</div>
      <h1 class="brand">BLE Simulator</h1>

      <div class="settings-section">
        <div class="simulator-grid">
          <!-- Heart Rate Simulation -->
          <div class="simulator-card">
            <div class="card-header">
              <h2>Heart Rate</h2>
              <label class="switch">
                <input type="checkbox" id="hrOutput" onchange="toggleHRCheckbox(this,true)">
                <span class="slider"></span>
              </label>
            </div>
            <div class="simulator-content">
              <div class="value-display">
                <span id="hrValue">-- BPM</span>
              </div>
              <div class="slider-group">
                <input type="range" id="hrSlider" min="40" max="250" value="0" step="1" 
                       onchange="updateHrSlider()" class="simulator-slider">
              </div>
            </div>
          </div>

          <!-- Power Output Simulation -->
          <div class="simulator-card">
            <div class="card-header">
              <h2>Power Output</h2>
              <label class="switch">
                <input type="checkbox" id="wattsOutput" onchange="toggleWattsCheckbox(this,true)">
                <span class="slider"></span>
              </label>
            </div>
            <div id="wattsInputContainer" class="simulator-content">
              <div class="value-display">
                <span id="wattsValue">-- W</span>
                <label class="auto-update">
                  <input type="checkbox" id="autoUpdateWatts" onclick="autoUpdateWattsClick()">
                  Auto Update
                </label>
              </div>
              <div class="slider-group">
                <input type="range" id="wattsSlider" min="0" max="600" value="0" step="1"
                       onchange="updateWattsSlider()" class="simulator-slider">
              </div>
            </div>
          </div>

          <!-- Cadence Simulation -->
          <div class="simulator-card">
            <div class="card-header">
              <h2>Cadence</h2>
              <label class="switch">
                <input type="checkbox" id="cadOutput" onchange="toggleCadCheckbox(this,true)">
                <span class="slider"></span>
              </label>
            </div>
            <div id="cadInputContainer" class="simulator-content">
              <div class="value-display">
                <span id="cadValue">-- RPM</span>
                <label class="auto-update">
                  <input type="checkbox" id="autoUpdateCadence" onclick="autoUpdateCadenceClick()">
                  Auto Update
                </label>
              </div>
              <div class="slider-group">
                <input type="range" id="cadSlider" min="0" max="180" value="0" step="1"
                       onchange="updateCadSlider()" class="simulator-slider">
              </div>
            </div>
          </div>

          <!-- ERG Mode Simulation -->
          <div class="simulator-card">
            <div class="card-header">
              <h2>ERG Mode</h2>
              <label class="switch">
                <input type="checkbox" id="enableErgCheckbox" onchange="toggleEnableErgCheckbox(this)">
                <span class="slider"></span>
              </label>
            </div>
            <div class="simulator-content">
              <div class="value-display">
                <span id="targetWattsValue">-- W</span>
                <label class="switch">
                  <input type="checkbox" id="targetWattsOutput" onchange="toggleTargetWattsCheckbox(this,true)">
                  <span class="slider"></span>
                </label>
              </div>
              <div class="slider-group">
                <input type="range" id="targetWattsSlider" min="0" max="600" value="0" step="1"
                       onchange="updateTargetWattsSlider()" class="simulator-slider">
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Update values on specified interval
    setInterval(requestConfigValues, 2000);

    function toggleHRCheckbox(element, updateServer) {
      if (element.checked) {
        document.getElementById("hrSlider").hidden = false;
        document.getElementById("hrValue").hidden = false;
      } else {
        document.getElementById("hrSlider").hidden = true;
        document.getElementById("hrValue").hidden = true;
      }
      
      if (updateServer) {
        fetch('/hrslider?value=' + (element.checked ? 'enable' : 'disable'), { method: 'GET' })
          .catch(error => console.error('Error:', error));
      }
    }

    function toggleWattsCheckbox(element, updateServer) {
      document.getElementById("wattsInputContainer").hidden = !element.checked;
      
      if (updateServer) {
        fetch('/wattsslider?value=' + (element.checked ? 'enable' : 'disable'), { method: 'GET' })
          .catch(error => console.error('Error:', error));
      }
    }

    function toggleCadCheckbox(element, updateServer) {
      document.getElementById("cadInputContainer").hidden = !element.checked;
      
      if (updateServer) {
        fetch('/cadslider?value=' + (element.checked ? 'enable' : 'disable'), { method: 'GET' })
          .catch(error => console.error('Error:', error));
      }
    }

    function updateHrSlider() {
      const value = document.getElementById("hrSlider").value;
      document.getElementById("hrValue").innerHTML = value + " BPM";
      fetch('/hrslider?value=' + value, { method: 'GET' })
        .catch(error => console.error('Error:', error));
    }

    function updateWattsSlider() {
      const value = document.getElementById("wattsSlider").value;
      document.getElementById("wattsValue").innerHTML = value + " Watts";
      fetch('/wattsslider?value=' + value, { method: 'GET' })
        .catch(error => console.error('Error:', error));
    }

    function updateCadSlider() {
      const value = document.getElementById("cadSlider").value;
      document.getElementById("cadValue").innerHTML = value + " RPM";
      fetch('/cadslider?value=' + value, { method: 'GET' })
        .catch(error => console.error('Error:', error));
    }

    function updateTargetWattsSlider() {
      const value = document.getElementById("targetWattsSlider").value;
      document.getElementById("targetWattsValue").innerHTML = value + " Watts";
      fetch('/targetwattsslider?value=' + value, { method: 'GET' })
        .catch(error => console.error('Error:', error));
    }

    function toggleTargetWattsCheckbox(element, updateServer) {
      document.getElementById("targetWattsSlider").hidden = !element.checked;
      document.getElementById("targetWattsValue").hidden = !element.checked;
      
      if (updateServer) {
        fetch('/targetwattsslider?value=' + (element.checked ? 'enable' : 'disable'), { method: 'GET' })
          .catch(error => console.error('Error:', error));
      }
    }

    function toggleEnableErgCheckbox(element) {
      fetch('/ergmode?value=' + (element.checked ? 'enable' : 'disable'), { method: 'GET' })
        .catch(error => console.error('Error:', error));
    }

    function requestConfigValues() {
      fetch('/runtimeConfigJSON')
        .then(response => response.json())
        .then(data => {
          // Update watts
          document.getElementById("wattsValue").innerHTML = data.watts + " Watts";
          document.getElementById("wattsSlider").value = data.watts;
          document.getElementById("wattsOutput").checked = data.simWatts;
          document.getElementById("wattsInputContainer").hidden = !data.simWatts;

          // Update heart rate
          document.getElementById("hrValue").innerHTML = data.hr + " BPM";
          document.getElementById("hrSlider").value = data.hr;
          document.getElementById("hrOutput").checked = data.simHr;
          document.getElementById("hrSlider").hidden = !data.simHr;
          document.getElementById("hrValue").hidden = !data.simHr;

          // Update cadence
          document.getElementById("cadValue").innerHTML = data.cad + " RPM";
          document.getElementById("cadSlider").value = data.cad;
          document.getElementById("cadOutput").checked = data.simCad;
          document.getElementById("cadInputContainer").hidden = !data.simCad;

          // Update ERG mode
          document.getElementById("enableErgCheckbox").checked = data.FTMSMode === "0x05";

          // Update target watts
          document.getElementById("targetWattsValue").innerHTML = data.targetWatts + " Watts";
          document.getElementById("targetWattsSlider").value = data.targetWatts ?? 0;
          document.getElementById("targetWattsOutput").checked = data.simTargetWatts;
          document.getElementById("targetWattsSlider").hidden = !data.simTargetWatts;
          document.getElementById("targetWattsValue").hidden = !data.simTargetWatts;

          // Remove loading watermark
          document.getElementById("loadingWatermark")?.remove();
        })
        .catch(error => console.error('Error:', error));
    }

    let updateWattsTimer = null;
    function autoUpdateWattsClick() {
      if (updateWattsTimer) {
        clearInterval(updateWattsTimer);
        updateWattsTimer = null;
      } else {
        updateWattsTimer = setInterval(() => {
          const slider = document.getElementById("wattsSlider");
          const offset = Math.random() * 10 - 5;
          const value = parseInt(slider.value, 10);
          slider.value = value + offset;
          updateWattsSlider();
        }, 1000);
      }
    }

    let updateCadenceTimer = null;
    function autoUpdateCadenceClick() {
      if (updateCadenceTimer) {
        clearInterval(updateCadenceTimer);
        updateCadenceTimer = null;
      } else {
        updateCadenceTimer = setInterval(() => {
          const slider = document.getElementById("cadSlider");
          const offset = Math.random() * 6 - 3;
          const value = parseInt(slider.value, 10);
          slider.value = value + offset;
          updateCadSlider();
        }, 1000);
      }
    }

    function loadCss() {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'style.css';
      document.head.appendChild(link);
    }

    window.addEventListener('load', () => {
      setTimeout(loadCss, 100);
      setTimeout(requestConfigValues, 500);
    });
  </script>
</body>
</html>
